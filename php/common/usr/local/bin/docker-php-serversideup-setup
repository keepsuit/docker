#!/bin/sh

set -e

docker-php-serversideup-dep-install-alpine "bash ffmpeg mysql-client htop"
docker-php-serversideup-dep-install-debian "ffmpeg htop"


# MySQL client doesn't work on alpine
if [ "$OS" != "alpine" ]; then
    echo "ðŸ¤– Installing MySQL client..."
    MYSQL_VERSION=8.4.8

    case ${TARGETARCH} in
        "amd64")  MYSQL_DIR=mysql-${MYSQL_VERSION}-linux-glibc2.28-x86_64-minimal  ;;
        "arm64")  MYSQL_DIR=mysql-${MYSQL_VERSION}-linux-glibc2.28-aarch64  ;;
    esac
    curl -fsSLO https://dev.mysql.com/get/Downloads/MySQL-8.4/${MYSQL_DIR}.tar.xz
    tar -xf ${MYSQL_DIR}.tar.xz
    mv ${MYSQL_DIR}/bin/mysqldump /usr/local/bin/mysqldump
    chmod +x /usr/local/bin/mysqldump
    rm -rf ${MYSQL_DIR}*
fi


echo "ðŸ¤– Installing grpc extension..."
GRPC_VERSION=1.78.0
PHP_EXTENSION_VERSION=$PHP_VERSION
if php -r 'exit(defined("PHP_ZTS") && PHP_ZTS ? 0 : 1);'; then
PHP_EXTENSION_VERSION="${PHP_VERSION}-zts"
fi
curl -fsSL -o grpc.so "https://s3.eu-central-1.amazonaws.com/docker-php-assets.keepsuit.com/extensions/${PHP_EXTENSION_VERSION}/${OS}/${TARGETARCH}/grpc-${GRPC_VERSION}.so"
PHP_EXTENSION_DIR=$(php-config --extension-dir)
mv grpc.so ${PHP_EXTENSION_DIR}/grpc.so
PHPIZE_DEPS="" docker-php-ext-enable grpc


echo "ðŸ¤– Installing supercronic..."
curl -fsSL -o supercronic "https://github.com/aptible/supercronic/releases/download/${SUPERCRONIC_VERSION}/supercronic-linux-${TARGETARCH}"
chmod +x supercronic
mv supercronic /usr/local/bin/supercronic
